# Development Guide

To develop the Bank of Anthos application locally, you will need:

- a GCP project
- the `PROJECT_ID` variable set to your project
- one GKE cluster (with at least 4 nodes, recommended machine type `n1-standard-4`)
- [skaffold](https://skaffold.dev/docs/install/) and [kubectl](https://kubernetes.io/docs/tasks/tools/install-kubectl/) installed to your local environment


### Build images and deploy once

```
skaffold run --default-repo=gcr.io/${PROJECT_ID}/bank-of-anthos
```

### Build images and deploy continuously

Use `skaffold dev` to automatically propagate code changes to your cluster on file save.

```
skaffold dev --default-repo=gcr.io/${PROJECT_ID}/bank-of-anthos
```


## Continuous Integration

GitHub Actions workflows [described here](../.github/workflows)


### Adding Packages in the Python Services

The `requirements.txt` file is auto-generated by `pip-compile`, then used by the Dockerfile to install python packages in the container.
To add a package, first add the package name to `requirements.in` within the service (ex: frontend service).
Then run:

```
cd bank-of-anthos/src/frontend/
python3 -m pip install pip-tools
python3 -m piptools compile --output-file=requirements.txt requirements.in

# run skaffold or docker build using the generated requirements.txt
```

Alternatively, you can also run:

```
cd bank-of-anthos/src/frontend/
python3 -m venv .
source ./bin/activate
pip install pip-tools

pip-compile --output-file=requirements.txt requirements.in

# run skaffold or docker build using the generated requirements.txt
```


## What is this branch

This branch implements trace-log correlation for the Java services. In order to integrate trace-log correlation the following changes were made:
- Swap of `log4j2` logging framework with `logback`
this is due to the fact that Spring Cloud Sleuth is currently missing integration with `log4j2` in regards to associating a log with trace ID and span ID.
   - As a consequence of this swap the FATAL log level has to be removed as logback does not support it.
- Added extra log output type with environment variable for JSON log output for trace-log correlation in Stackdriver (does not intake txt logs for trace-log correlation) 
