# Google Cloud Spanner Migration Guide

This document describes the migration of the Bank of Anthos ledger database from PostgreSQL to Google Cloud Spanner.

## Overview

The ledger database has been migrated from PostgreSQL to Google Cloud Spanner, a globally distributed, horizontally scalable relational database service. This migration provides:

- **Global consistency**: Strong consistency across regions
- **Horizontal scalability**: Automatic sharding and replication
- **High availability**: 99.999% SLA availability
- **No planned downtime**: For maintenance or upgrades

## Architecture Changes

### Database Schema

The `TRANSACTIONS` table schema has been converted from PostgreSQL to Spanner DDL:

**PostgreSQL (Original):**
```sql
CREATE TABLE TRANSACTIONS (
    TRANSACTION_ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    FROM_ACCT CHAR(10) NOT NULL,
    ...
);
```

**Spanner (New):**
```sql
CREATE TABLE TRANSACTIONS (
    TRANSACTION_ID INT64 NOT NULL,
    FROM_ACCT STRING(10) NOT NULL,
    ...
) PRIMARY KEY (TRANSACTION_ID);

CREATE SEQUENCE TRANSACTION_SEQ OPTIONS (
  sequence_kind = "bit_reversed_positive"
);
```

### Key Changes

1. **Data Types**:
   - `BIGINT` → `INT64`
   - `CHAR(n)` → `STRING(n)`
   - `INT` → `INT64`
   - `TIMESTAMP` → `TIMESTAMP`

2. **Primary Key**:
   - Uses Spanner sequence with bit-reversed positive sequence for optimal performance
   - Prevents hotspots by distributing writes across multiple servers

3. **Indexes**:
   - Named indexes required in Spanner
   - `IDX_TRANSACTIONS_FROM` on (FROM_ACCT, FROM_ROUTE, TIMESTAMP)
   - `IDX_TRANSACTIONS_TO` on (TO_ACCT, TO_ROUTE, TIMESTAMP)

4. **Append-Only Enforcement**:
   - PostgreSQL used RULES to prevent updates/deletes
   - Spanner enforces this through IAM permissions and application logic

## Application Changes

### Maven Dependencies

**Removed:**
```xml
<dependency>
    <groupId>org.postgresql</groupId>
    <artifactId>postgresql</artifactId>
</dependency>
```

**Added:**
```xml
<dependency>
    <groupId>com.google.cloud</groupId>
    <artifactId>google-cloud-spanner-jdbc</artifactId>
</dependency>
<dependency>
    <groupId>com.google.cloud</groupId>
    <artifactId>google-cloud-spanner-hibernate-dialect</artifactId>
</dependency>
```

### Spring Configuration

**application.properties:**
```properties
# Changed from PostgreSQLDialect to SpannerDialect
spring.jpa.database-platform=com.google.cloud.spanner.hibernate.SpannerDialect
spring.jpa.hibernate.ddl-auto=none
```

### Entity Classes

Updated `@GeneratedValue` strategy in Transaction entity:

**Before:**
```java
@GeneratedValue(strategy = GenerationType.IDENTITY)
```

**After:**
```java
@GeneratedValue(strategy = GenerationType.SEQUENCE, generator = "transaction_seq_generator")
@SequenceGenerator(name = "transaction_seq_generator", sequenceName = "TRANSACTION_SEQ")
```

## Deployment Instructions

### Prerequisites

1. Google Cloud Project with billing enabled
2. gcloud CLI installed and configured
3. Appropriate IAM permissions:
   - `spanner.instances.create`
   - `spanner.databases.create`
   - `spanner.databases.updateDdl`

### Step 1: Set Environment Variables

Update the ConfigMap in `src/ledger/ledger-db/k8s/base/config.yaml`:

```yaml
data:
  SPANNER_PROJECT_ID: "your-gcp-project-id"
  SPANNER_INSTANCE_ID: "bank-of-anthos-ledger"
  SPANNER_DATABASE_ID: "ledger-db"
  SPRING_DATASOURCE_URL: "jdbc:cloudspanner:/projects/your-gcp-project-id/instances/bank-of-anthos-ledger/databases/ledger-db"
```

### Step 2: Initialize Spanner Database

Run the initialization script:

```bash
export SPANNER_PROJECT_ID="your-gcp-project-id"
export SPANNER_INSTANCE_ID="bank-of-anthos-ledger"
export SPANNER_DATABASE_ID="ledger-db"
export USE_DEMO_DATA="True"  # Optional: Load demo transactions
export LOCAL_ROUTING_NUM="883745000"

cd src/ledger/ledger-db/initdb
chmod +x init-spanner.sh
./init-spanner.sh
```

This script will:
1. Create a Spanner instance (if it doesn't exist)
2. Create the database
3. Apply the DDL schema
4. Load demo data (if USE_DEMO_DATA=True)

### Step 3: Deploy Applications

Deploy the ledger services to Kubernetes:

```bash
kubectl apply -f kubernetes-manifests/ledger-writer.yaml
kubectl apply -f kubernetes-manifests/balance-reader.yaml
kubectl apply -f kubernetes-manifests/transaction-history.yaml
```

Or deploy the monolith version:

```bash
kubectl apply -f kubernetes-manifests/ledgermonolith.yaml
```

## Connection String Format

Spanner JDBC connection strings follow this format:

```
jdbc:cloudspanner:/projects/{PROJECT_ID}/instances/{INSTANCE_ID}/databases/{DATABASE_ID}
```

Optional parameters:
- `?credentials=/path/to/credentials.json` - Service account credentials
- `?autocommit=false` - Disable auto-commit mode
- `?readonly=true` - Read-only mode

## Performance Considerations

### Sequence Configuration

The `TRANSACTION_SEQ` uses `bit_reversed_positive` sequence kind, which:
- Distributes sequential IDs across the keyspace
- Prevents hotspots on the primary key
- Maintains monotonically increasing values within a single session

### Query Optimization

All existing queries are compatible with Spanner. The native SQL queries use standard SQL syntax supported by Spanner.

### Cost Optimization

For development/testing, use a single-node regional instance:
```bash
export SPANNER_INSTANCE_CONFIG="regional-us-central1"
export SPANNER_INSTANCE_NODES="1"
```

For production, consider:
- Multi-regional configuration for global applications
- Appropriate node count based on throughput requirements
- Spanner autoscaling (if using processing units instead of nodes)

## Monitoring

Monitor Spanner performance using:

1. **Cloud Console**: https://console.cloud.google.com/spanner
2. **Cloud Monitoring**: Metrics for CPU utilization, latency, and throughput
3. **Query Insights**: Analyze slow queries and execution plans

## Troubleshooting

### Common Issues

**Issue**: "Instance not found" error
- **Solution**: Ensure instance exists or run init script with proper permissions

**Issue**: "Permission denied" during DDL update
- **Solution**: Verify service account has `spanner.databases.updateDdl` permission

**Issue**: "DEADLINE_EXCEEDED" errors
- **Solution**: Increase timeout or check instance capacity

### Rollback to PostgreSQL

To rollback to PostgreSQL:

1. Restore PostgreSQL dependencies in pom.xml
2. Update application.properties dialect
3. Revert Transaction entity GeneratedValue strategy
4. Deploy PostgreSQL database
5. Update ConfigMap with PostgreSQL connection string

## Migration Verification

After migration, verify:

1. **Schema**: Check tables, indexes, and sequences exist
   ```bash
   gcloud spanner databases ddl describe $SPANNER_DATABASE_ID \
     --instance=$SPANNER_INSTANCE_ID --project=$SPANNER_PROJECT_ID
   ```

2. **Data**: Verify demo transactions loaded
   ```bash
   gcloud spanner databases execute-sql $SPANNER_DATABASE_ID \
     --instance=$SPANNER_INSTANCE_ID --project=$SPANNER_PROJECT_ID \
     --sql="SELECT COUNT(*) FROM TRANSACTIONS"
   ```

3. **Application**: Test transaction creation via API
   ```bash
   curl -X POST http://ledger-writer-service/transactions \
     -H "Content-Type: application/json" \
     -d '{"fromAccountNum":"1011226111", ...}'
   ```

## References

- [Cloud Spanner Documentation](https://cloud.google.com/spanner/docs)
- [Spanner JDBC Driver](https://cloud.google.com/spanner/docs/jdbc-drivers)
- [Hibernate Spanner Dialect](https://github.com/GoogleCloudPlatform/google-cloud-spanner-hibernate)
- [Best Practices for Schema Design](https://cloud.google.com/spanner/docs/schema-design)
